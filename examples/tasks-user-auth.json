{
  "$schema": "https://raw.githubusercontent.com/Gens-ai/autopilot/main/tasks.schema.json",
  "name": "user-auth",
  "description": "User authentication system with email/password and OAuth",
  "goals": [
    "Enable secure user registration and login",
    "Support multiple authentication methods",
    "Implement secure session management"
  ],
  "nonGoals": [
    "Two-factor authentication",
    "Admin user management",
    "Enterprise SSO"
  ],
  "technicalNotes": "Using bcrypt for passwords, JWT for sessions, passport.js for OAuth",
  "_tdd": true,
  "_priority_order": [
    "1. Architectural decisions and core abstractions",
    "2. Integration points between modules",
    "3. Unknown unknowns and spike work",
    "4. Standard features and implementation",
    "5. Polish, cleanup, and quick wins"
  ],
  "_step_size": "One logical change per commit. Quality over speed.",
  "requirements": [
    {
      "id": "1",
      "category": "functional",
      "priority": "high",
      "description": "Create User model with email, password hash, and verification status",
      "testType": "unit",
      "codeAnalysis": {
        "approach": "create",
        "existingFiles": ["src/models/index.ts", "src/db/schema.ts"],
        "relatedTests": ["src/models/__tests__/BaseModel.test.ts"],
        "patterns": [
          "Models extend BaseModel class",
          "Use Zod for validation schemas",
          "Password hashing via bcrypt utility in src/lib/crypto.ts"
        ],
        "targetFiles": {
          "modify": ["src/models/index.ts"],
          "create": ["src/models/User.ts", "src/models/__tests__/User.test.ts"]
        }
      },
      "acceptance": [
        "User can be created with valid email and password",
        "Invalid email format rejected with clear error",
        "Password stored as bcrypt hash, never plaintext",
        "Duplicate email rejected with conflict error"
      ],
      "tdd": {
        "test": {
          "description": "Create User.test.ts covering all acceptance criteria: valid creation, email validation, password hashing, duplicate rejection",
          "file": "src/models/__tests__/User.test.ts",
          "passes": false
        },
        "implement": {
          "description": "Create User model extending BaseModel, use existing Zod patterns from schema.ts, integrate bcrypt from src/lib/crypto.ts",
          "passes": false
        },
        "refactor": {
          "description": "Extract email validation regex to shared constants if duplicated elsewhere",
          "passes": false
        }
      },
      "verification": [
        "User model exists with required fields",
        "Passwords are hashed with bcrypt",
        "Email validation works via Zod schema"
      ],
      "passes": false
    },
    {
      "id": "2",
      "category": "functional",
      "priority": "high",
      "description": "Implement user registration endpoint",
      "dependsOn": ["1"],
      "testType": "integration",
      "issue": "#101",
      "codeAnalysis": {
        "approach": "extend",
        "existingFiles": [
          "src/routes/index.ts",
          "src/controllers/BaseController.ts",
          "src/middleware/validation.ts"
        ],
        "relatedTests": ["src/routes/__tests__/health.test.ts"],
        "patterns": [
          "Controllers extend BaseController",
          "Use validation middleware with Zod schemas",
          "Routes registered in src/routes/index.ts"
        ],
        "targetFiles": {
          "modify": ["src/routes/index.ts"],
          "create": [
            "src/controllers/AuthController.ts",
            "src/routes/__tests__/auth.test.ts"
          ]
        }
      },
      "acceptance": [
        "POST /auth/register returns 201 with JWT on valid input",
        "Invalid email returns 400 with validation error",
        "Weak password returns 400 with strength requirements",
        "Duplicate email returns 409 conflict",
        "JWT contains user ID and email claims"
      ],
      "tdd": {
        "test": {
          "description": "Create auth.test.ts covering all acceptance criteria: successful registration, validation errors, conflicts, JWT structure",
          "file": "src/routes/__tests__/auth.test.ts",
          "passes": false
        },
        "implement": {
          "description": "Create AuthController extending BaseController, add registration route to routes/index.ts, use existing validation middleware",
          "passes": false
        },
        "refactor": {
          "description": "Add rate limiting using existing middleware pattern from src/middleware/",
          "passes": false
        }
      },
      "verification": [
        "Registration creates user in database",
        "Returns JWT token on success",
        "Validates email format and password strength via Zod"
      ],
      "passes": false
    },
    {
      "id": "3",
      "category": "functional",
      "priority": "high",
      "description": "Implement login endpoint",
      "dependsOn": ["1", "2"],
      "testType": "integration",
      "issue": "#102",
      "codeAnalysis": {
        "approach": "extend",
        "existingFiles": [
          "src/controllers/AuthController.ts",
          "src/lib/crypto.ts",
          "src/lib/jwt.ts"
        ],
        "relatedTests": ["src/routes/__tests__/auth.test.ts"],
        "patterns": [
          "JWT generation via src/lib/jwt.ts",
          "Password comparison via bcrypt.compare in crypto.ts"
        ],
        "targetFiles": {
          "modify": [
            "src/controllers/AuthController.ts",
            "src/routes/index.ts"
          ],
          "create": []
        }
      },
      "acceptance": [
        "POST /auth/login returns 200 with JWT for valid credentials",
        "Invalid password returns 401 unauthorized",
        "Non-existent email returns 401 (no user enumeration)",
        "JWT expires after configured duration",
        "Response format matches registration endpoint"
      ],
      "tdd": {
        "test": {
          "description": "Add login tests covering all acceptance criteria: valid login, wrong password, unknown email, JWT expiry",
          "file": "src/routes/__tests__/auth.test.ts",
          "passes": false
        },
        "implement": {
          "description": "Add login method to AuthController, use existing jwt.ts for token generation, crypto.ts for password verification",
          "passes": false
        },
        "refactor": {
          "description": "Extract auth response formatting to shared helper if duplicated with registration",
          "passes": false
        }
      },
      "verification": [
        "Correct credentials return JWT",
        "Wrong credentials return 401",
        "Response format matches registration endpoint"
      ],
      "passes": false
    },
    {
      "id": "4",
      "category": "functional",
      "priority": "medium",
      "description": "Implement password reset flow",
      "dependsOn": ["1"],
      "testType": "integration",
      "codeAnalysis": {
        "approach": "extend",
        "existingFiles": [
          "src/controllers/AuthController.ts",
          "src/services/EmailService.ts",
          "src/lib/crypto.ts"
        ],
        "relatedTests": ["src/routes/__tests__/auth.test.ts"],
        "patterns": [
          "Email sending via EmailService.send()",
          "Token generation via crypto.randomBytes pattern in crypto.ts"
        ],
        "targetFiles": {
          "modify": [
            "src/controllers/AuthController.ts",
            "src/routes/index.ts"
          ],
          "create": ["src/models/PasswordResetToken.ts"]
        }
      },
      "acceptance": [
        "POST /auth/forgot-password sends email within 5 seconds",
        "Reset token expires after 1 hour",
        "POST /auth/reset-password with valid token updates password",
        "Used token cannot be reused",
        "Invalid token returns 400 error",
        "Non-existent email returns 200 (no user enumeration)"
      ],
      "tdd": {
        "test": {
          "description": "Add password reset tests covering all acceptance criteria: email sending, token expiry, password update, token reuse prevention",
          "file": "src/routes/__tests__/auth.test.ts",
          "passes": false
        },
        "implement": {
          "description": "Create PasswordResetToken model, add forgot/reset endpoints to AuthController, use existing EmailService for notifications",
          "passes": false
        },
        "refactor": {
          "description": "Add token expiration cleanup job or document manual cleanup process",
          "passes": false
        }
      },
      "verification": [
        "Reset email is sent via EmailService",
        "Token allows password change",
        "Token expires after use or timeout"
      ],
      "passes": false
    },
    {
      "id": "5",
      "category": "functional",
      "priority": "medium",
      "description": "Add Google OAuth login",
      "dependsOn": ["1"],
      "testType": "e2e",
      "codeAnalysis": {
        "approach": "create",
        "existingFiles": [
          "src/controllers/AuthController.ts",
          "src/config/env.ts"
        ],
        "relatedTests": [],
        "patterns": [
          "Environment config via src/config/env.ts",
          "No existing OAuth patterns - will establish new pattern"
        ],
        "targetFiles": {
          "modify": [
            "src/controllers/AuthController.ts",
            "src/routes/index.ts",
            "src/config/env.ts"
          ],
          "create": [
            "src/auth/strategies/google.ts",
            "src/auth/strategies/index.ts",
            "e2e/auth-oauth.spec.ts"
          ]
        }
      },
      "acceptance": [
        "GET /auth/google redirects to Google OAuth consent screen",
        "GET /auth/google/callback creates new user if email not exists",
        "GET /auth/google/callback links to existing user if email exists",
        "Callback returns JWT matching email/password format",
        "Missing GOOGLE_CLIENT_ID fails gracefully with clear error"
      ],
      "tdd": {
        "test": {
          "description": "Create e2e/auth-oauth.spec.ts covering all acceptance criteria: redirect URL, new user creation, existing user linking, JWT format",
          "file": "e2e/auth-oauth.spec.ts",
          "passes": false
        },
        "implement": {
          "description": "Create google.ts strategy using passport-google-oauth20, add OAuth routes, extend env.ts with GOOGLE_CLIENT_ID/SECRET",
          "passes": false
        },
        "refactor": {
          "description": "Extract OAuth config to separate config file, document required environment variables in README",
          "passes": false
        }
      },
      "verification": [
        "Google login redirects correctly",
        "Callback creates/links user",
        "Returns valid JWT matching email/password flow format"
      ],
      "passes": false
    }
  ]
}
